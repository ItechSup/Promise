<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <style type="text/css">
        .chapter::first-letter {
            color: red;
            font-size: 130%;
        }
    </style>

    <title>Traitement asynchrone</title>
</head>
<body>
    <div class="spinner">
        <img src="spinner.gif" alt="chargement...">
    </div>
    <div id="story">

    </div>
    <div id="message">

    </div>

    <script>
        function get(url) {
            // Return a new promise.
            return new Promise(function(resolve, reject) {
                // Do the usual XHR stuff
                var req = new XMLHttpRequest();
                req.open('GET', url);

                req.onload = function() {
                    // This is called even on 404 etc
                    // so check the status
                    if (req.status == 200) {
                        // Resolve the promise with the response text
                        resolve(req.response);
                    }
                    else {
                        // Otherwise reject with the status text
                        // which will hopefully be a meaningful error
                        reject(Error(req.statusText));
                    }
                };

                // Handle network errors
                req.onerror = function() {
                    reject(Error("Network Error"));
                };

                // Make the request
                req.send();
            });
        }

        function getJSON(url) {
            return get(url).then(JSON.parse);
        }

        function addHtmlToPage(text) {
            chapter = document.createElement('div');
            chapter.className = 'chapter';
            chapter.innerHTML = text;
            document.getElementById('story').appendChild(chapter);
        }
        function addTextToPage(text) {
            message = document.createElement('div');
            message.innerHTML = text;
            document.getElementById('message').appendChild(message);
        }

        getJSON('story.json').then(function(story) {
            addHtmlToPage(story.heading);

            // Map our array of chapter urls to
            // an array of chapter json promises.
            // This makes sure they all download parallel.
            return story.chapterUrls.map(getJSON)
                    .reduce(function(sequence, chapterPromise) {
                        // Use reduce to chain the promises together,
                        // adding content to the page for each chapter
                        return sequence.then(function() {
                            // Wait for everything in the sequence so far,
                            // then wait for this chapter to arrive.
                            return chapterPromise;
                        }).then(function(chapter) {
                            addHtmlToPage(chapter.html);
                        });
                    }, Promise.resolve());
        }).then(function() {
            addTextToPage("All done");
        }).catch(function(err) {
            // catch any error that happened along the way
            addTextToPage("Argh, broken: " + err.message);
        }).then(function() {
            document.querySelector('.spinner').style.display = 'none';
        });

        var sequence = Promise.resolve();

    </script>
</body>
</html>